<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeoApp ‚Äî Enschede Map</title>
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root { --panel-w: 25vw; }
html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; background:#f7f7f7; color:#222; }
.app { display:flex; height:100vh; }
#map, #report { width: calc(100% - var(--panel-w)); height:100%; position: relative; }
#report { display:none; padding:20px; overflow:auto; background:#fff; }
.panel { width: var(--panel-w); min-width: 260px; background:#fff; border-left:1px solid #e0e0e0; padding:16px; overflow:auto; box-shadow:-2px 0 6px rgba(0,0,0,0.04); }
.brand { font-weight:700; font-size:1.1rem; margin-bottom:8px; }
.section { margin-bottom: 18px; }
.separator { height:1px; background:#eee; margin: 12px 0; }
.search-bar { position: relative; }
.search-bar input { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; }
.btn { margin-top:8px; width:100%; padding:8px 10px; background:#006400; color:white; border:none; border-radius:6px; cursor:pointer; }
.prop-list { display:flex; flex-direction:column; gap:8px; margin-top:12px; }
.prop-item { padding:8px 10px; background:#fafafa; border:1px solid #eee; border-radius:6px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
.prop-item:hover { background:#f0f8ff; }
.icon-btn { cursor:pointer; font-size:1.2rem; margin-left:8px; user-select:none; }
.radio-list label { display:flex; align-items:center; gap:10px; padding:8px 6px; border-radius:6px; cursor:pointer; }
.radio-list input[type="radio"] { transform:scale(1.05); }
.legend { margin-top:10px; font-size:0.9rem; }
.legend .row { display:flex; align-items:center; gap:8px; margin:6px 0; }
.swatch { width:18px;height:12px;border-radius:3px;border:1px solid #ccc; }
.charts { display:grid; gap:24px; }
canvas { max-width:100%; }
.autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #ccc; border-radius: 4px; z-index: 1000; max-height: 200px; overflow-y: auto; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
.autocomplete-item { padding: 8px 10px; cursor: pointer; }
.autocomplete-item:hover { background: #f0f8ff; }

/* --- Map Loading Spinner --- */
#mapLoading {
  display: none;
  position: absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background: rgba(255,255,255,0.6);
  z-index: 1000;
  display: flex;
  justify-content: center;
  align-items: center;
}

#mapLoading::after {
  content:'';
  width:40px;
  height:40px;
  border:5px solid #ccc;
  border-top-color:#006400;
  border-radius:50%;
  animation:spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
<body>
<div class="app">
  <div id="map">
    <div id="mapLoading"></div>
  </div>
  <div id="report">
    <h2 id="reportTitle">Property Report</h2>
    <div class="charts">
      <canvas id="chart1"></canvas>
      <canvas id="chart2"></canvas>
      <canvas id="chart3"></canvas>
    </div>
  </div>
  <aside class="panel">
    <div class="brand">GeoApp ‚Äî Enschede</div>
    <div class="section">
      <strong>Search for property</strong>
      <div class="search-bar" style="margin-top:6px;">
        <input type="text" id="searchInput" placeholder="Enter address..." autocomplete="off" />
      </div>
      <button class="btn" id="searchBtn">Search</button>
      <div class="prop-list" id="propertyList"></div>
    </div>
    <div class="separator"></div>
    <div class="section">
      <strong>Show layer on map</strong>
      <div class="radio-list" style="margin-top:8px;">
        <label><input type="radio" name="metric" value="none" checked> None</label>
        <label><input type="radio" name="metric" value="heat"> Urban Heat Islands</label>
        <label><input type="radio" name="metric" value="flood"> Flood Risk</label>
        <label><input type="radio" name="metric" value="air"> Air Quality</label>
        <label><input type="radio" name="metric" value="green"> Greenspace Access</label>
        <div id="infraMenuWrapper">
          <label>
            <input type="radio" name="metric" value="infra"> Access to Critical Infrastructure
            <span id="infraToggle" style="margin-left:6px; cursor:pointer;">‚ñæ</span>
          </label>
          <div id="infraMenu" style="display:none; margin-left:22px; margin-top:6px;">
            <label><input type="checkbox" value="hospital" checked> Hospitals</label><br>
            <label><input type="checkbox" value="school" checked> Schools</label><br>
            <label><input type="checkbox" value="police" checked> Police</label><br>
            <label><input type="checkbox" value="fire_station" checked> Fire Stations</label><br>
            <label><input type="checkbox" value="bus_station" checked> Bus Stations</label><br>
            <label><input type="checkbox" value="bus_stop" checked> Bus Stops</label><br>
            <label><input type="checkbox" value="station" checked> Train Stations</label><br>
            <label><input type="checkbox" value="airport" checked> Airports</label>
          </div>
        </div>
        <label><input type="radio" name="metric" value="crime"> Crime Rate</label>
      </div>
      <div class="legend" id="legend" style="display:none;">
        <div style="font-weight:600; margin-bottom:6px;">Legend (demo)</div>
        <div class="row"><div class="swatch" style="background:#2b83ba"></div><div>Low</div></div>
        <div class="row"><div class="swatch" style="background:#7fbf7b"></div><div>Medium</div></div>
        <div class="row"><div class="swatch" style="background:#fee08b"></div><div>High</div></div>
      </div>
    </div>
  </aside>
</div>

<script>
// --- Map Initialization ---
const center = [52.221537, 6.893661];
const map = L.map('map').setView(center, 13);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

// GIBS layers
const gibsLST = L.tileLayer('https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_Land_Surface_Temp_Day/default/2023-08-15/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png', { attribution:'NASA GIBS', tileSize:256, opacity:0.7 });
const gibsAirPollution = L.tileLayer('https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/OMPS_Aerosol_Index/default/2024-09-01/GoogleMapsCompatible_Level6/{z}/{y}/{x}.png', { attribution:'NASA GIBS', tileSize:256, opacity:0.7 });
const allGibsLayers = [gibsLST, gibsAirPollution];
function showLayer(name){ allGibsLayers.forEach(l=>map.removeLayer(l)); if(name==='temp') map.addLayer(gibsLST); else if(name==='pollution') map.addLayer(gibsAirPollution);}
function hideAllLayers(){ allGibsLayers.forEach(l=>map.removeLayer(l)); }

// --- Charts ---
let chartInstances=[];
function renderCharts(){
  chartInstances.forEach(ch=>ch.destroy());
  chartInstances=[];
  const labels=["2019","2020","2021","2022","2023","2024","2025"];
  const randomData=()=>labels.map(()=>Math.floor(Math.random()*100));
  chartInstances.push(new Chart(chart1,{type:'line',data:{labels,datasets:[{label:"Urban Heat",data:randomData(),borderColor:"orange"}]}}));
  chartInstances.push(new Chart(chart2,{type:'line',data:{labels,datasets:[{label:"Flood Risk",data:randomData(),borderColor:"blue"}]}}));
  chartInstances.push(new Chart(chart3,{type:'line',data:{labels,datasets:[{label:"Crime Rate",data:randomData(),borderColor:"red"}]}}));
}

// --- Report toggle ---
let reportVisible=false;
function showReport(name){map.getContainer().style.display="none"; report.style.display="block"; reportTitle.innerText=name+" ‚Äî Report"; renderCharts(); reportVisible=true;}
function showMap(){map.getContainer().style.display="block"; report.style.display="none"; reportVisible=false;}

// --- Property handling ---
let currentProperty=null;
function clearProperties(){propertyList.innerHTML=""; if(currentProperty){map.removeLayer(currentProperty.marker); currentProperty=null;}}
function addProperty(name,lat,lng){
  clearProperties();
  const marker=L.marker([lat,lng]).addTo(map).bindPopup(`<b>${name}</b>`);
  currentProperty={marker,lat,lng,name};
  const item=document.createElement("div");
  item.className="prop-item";
  item.innerHTML=`<div><div style="font-weight:600">${name}</div></div><div><span class="icon-btn">${reportVisible?'üó∫Ô∏è':'üìä'}</span></div>`;
  propertyList.appendChild(item);
  item.addEventListener("click",()=>{map.setView([lat,lng],17); marker.openPopup();});
  const icon=item.querySelector(".icon-btn");
  icon.addEventListener("click",e=>{
    e.stopPropagation();
    if(reportVisible){ showMap(); icon.textContent="üìä"; } else { showReport(name); icon.textContent="üó∫Ô∏è"; }
  });
}

// --- Overpass POIs with background preload ---
const overpassEndpoint='https://overpass-api.de/api/interpreter';
let poiLayerGroup = L.markerClusterGroup();
map.addLayer(poiLayerGroup);
const poiCache = {};
const infraTypes = ["hospital","school","police","fire_station","bus_station","bus_stop","station","airport"];
const mapLoading = document.getElementById('mapLoading');

function getBBoxKey(bounds){
  const lat=Math.round((bounds.getCenter().lat + Number.EPSILON)*10)/10;
  const lon=Math.round((bounds.getCenter().lng + Number.EPSILON)*10)/10;
  return `${lat}_${lon}`;
}

// Preload all infrastructure data silently
function preloadPOIs() {
  const bounds = map.getBounds();
  const bboxKey = getBBoxKey(bounds);

  infraTypes.forEach(type => {
    if(!poiCache[type]) poiCache[type]={};
    if(!poiCache[type][bboxKey]){
      const filter = getOverpassFilter(type, bounds);
      if(!filter) return;
      const query = `[out:json][timeout:25];(${filter});out center;`;
      fetch(overpassEndpoint, {method:"POST", body:query, headers:{"Content-Type":"application/x-www-form-urlencoded"}})
        .then(res=>res.json())
        .then(osm=>{ poiCache[type][bboxKey]=osm.elements; })
        .catch(err=>console.error(err));
    }
  });
}
map.whenReady(preloadPOIs);

// Overpass filter helper
function getOverpassFilter(type, bounds){
  const bboxStr = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
  if(["hospital","school","police","fire_station","bus_station"].includes(type)) return `node["amenity"="${type}"](${bboxStr});`;
  if(type==="bus_stop") return `node["highway"="bus_stop"](${bboxStr});`;
  if(type==="station") return `node["railway"="station"](${bboxStr});`;
  if(type==="airport") return `node["aeroway"~"aerodrome|airport"](${bboxStr});`;
  return "";
}

// Load infrastructure with conditional spinner
async function loadPOIsForMap(selectedTypes=[]){
  poiLayerGroup.clearLayers();
  const bounds = map.getBounds();
  const bboxKey = getBBoxKey(bounds);

  // Show spinner only if any type not yet loaded
  const needLoading = selectedTypes.some(t=>!poiCache[t] || !poiCache[t][bboxKey]);
  if(needLoading) mapLoading.style.display='flex';

  for(const type of selectedTypes){
    if(!poiCache[type]) poiCache[type]={};
    if(!poiCache[type][bboxKey]){
      const filter = getOverpassFilter(type, bounds);
      if(!filter) continue;
      const query = `[out:json][timeout:25];(${filter});out center;`;
      try{
        const res = await fetch(overpassEndpoint, {method:"POST", body:query, headers:{"Content-Type":"application/x-www-form-urlencoded"}});
        const osm = await res.json();
        poiCache[type][bboxKey] = osm.elements;
      } catch(err){ console.error(err); }
    }
    if(poiCache[type][bboxKey]) addPOIsToMap(poiCache[type][bboxKey]);
  }

  mapLoading.style.display='none';
}

function addPOIsToMap(elements){
  elements.forEach(f=>{
    const lat=f.lat||f.center?.lat;
    const lon=f.lon||f.center?.lon;
    if(!lat||!lon) return;
    const t=f.tags.amenity||f.tags.highway||f.tags.railway||f.tags.aeroway;
    let iconUrl='icons/hospital.png';
    if(t==='school') iconUrl='icons/school.png';
    else if(t==='police') iconUrl='icons/police.png';
    else if(t==='fire_station') iconUrl='icons/fire-department.png';
    else if(t==='bus_station'||t==='bus_stop') iconUrl='icons/bus.png';
    else if(t==='station'||t==='railway') iconUrl='icons/train.png';
    else if(t==='aeroway'||t==='airport') iconUrl='icons/airport.png';

    const icon = L.icon({iconUrl, iconSize:[32,32], iconAnchor:[16,32]});
    const name=f.tags.name||t;
    const marker=L.marker([lat,lon],{icon});
    marker.bindPopup(`<strong>${name}</strong><br>Type: ${t}`);
    poiLayerGroup.addLayer(marker);
  });
}

// --- Menu interactions ---
const infraToggle = document.getElementById("infraToggle");
const infraMenu = document.getElementById("infraMenu");
infraToggle.addEventListener("click", ()=>{
  const visible = infraMenu.style.display==="block";
  infraMenu.style.display=visible?"none":"block";
  infraToggle.textContent = visible?"‚ñæ":"‚ñ¥";
});
function reloadInfra(){
  const selected=[...document.querySelectorAll('#infraMenu input[type="checkbox"]:checked')].map(el=>el.value);
  loadPOIsForMap(selected);
}
document.querySelectorAll('#infraMenu input[type="checkbox"]').forEach(cb=>cb.addEventListener('change', reloadInfra));

// --- Map move / metric ---
map.on('moveend', ()=>{
  const selected=document.querySelector('input[name="metric"]:checked').value;
  if(selected==='infra'){
    if(map.getZoom()>=12) reloadInfra(); else { poiLayerGroup.clearLayers(); console.log("üó∫Ô∏è Too zoomed out"); }
  }
});

// --- Radio switch ---
document.querySelectorAll('input[name="metric"]').forEach(radio=>{
  radio.addEventListener('change', e=>{
    poiLayerGroup.clearLayers();
    const val = e.target.value;
    if(val==='infra'){
      reloadInfra();
    } else {
      hideAllLayers(); // remove GIBS layers if switching metric
    }
  });
});
</script>
</body>
</html>
