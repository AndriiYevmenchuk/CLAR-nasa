<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeoApp ‚Äî Enschede Map</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{ --panel-w: 25vw; }
  html,body{ height:100%; margin:0; font-family: Arial, sans-serif; background:#f7f7f7; color:#222; }
  .app { display:flex; height:100vh; }

  #map, #report { width: calc(100% - var(--panel-w)); height:100%; }
  #report { display:none; padding:20px; overflow:auto; background:#fff; }

  .panel { width: var(--panel-w); min-width: 260px; background:#fff; border-left:1px solid #e0e0e0; padding:16px; overflow:auto; box-shadow:-2px 0 6px rgba(0,0,0,0.04); }

  .brand { font-weight:700; font-size:1.1rem; margin-bottom:8px; }
  .section { margin-bottom: 18px; }
  .separator { height:1px; background:#eee; margin: 12px 0; }

  .search-bar { position: relative; }
  .search-bar input { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; }

  .btn { margin-top:8px; width:100%; padding:8px 10px; background:#006400; color:white; border:none; border-radius:6px; cursor:pointer; }

  .prop-list { display:flex; flex-direction:column; gap:8px; margin-top:12px; }
  .prop-item { padding:8px 10px; background:#fafafa; border:1px solid #eee; border-radius:6px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
  .prop-item:hover { background:#f0f8ff; }

  .icon-btn { cursor:pointer; font-size:1.2rem; margin-left:8px; user-select:none; }

  .radio-list label{ display:flex; align-items:center; gap:10px; padding:8px 6px; border-radius:6px; cursor:pointer; }
  .radio-list input[type="radio"] { transform:scale(1.05); }

  .legend { margin-top:10px; font-size:0.9rem; }
  .legend .row{ display:flex; align-items:center; gap:8px; margin:6px 0; }
  .swatch { width:18px;height:12px;border-radius:3px;border:1px solid #ccc; }

  .charts { display:grid; gap:24px; }
  canvas { max-width:100%; }
</style>
</head>
<body>

<div class="app">
  <!-- Map -->
  <div id="map"></div>

  <!-- Report view -->
  <div id="report">
    <h2 id="reportTitle">Property Report</h2>
    <div class="charts">
      <canvas id="chart1"></canvas>
      <canvas id="chart2"></canvas>
      <canvas id="chart3"></canvas>
    </div>
  </div>

  <!-- Side panel -->
  <aside class="panel">
    <div class="brand">GeoApp ‚Äî Enschede</div>

    <div class="section">
      <strong>Search for property</strong>
      <div class="search-bar" style="margin-top:6px;">
        <input type="text" id="searchInput" placeholder="Enter address..." autocomplete="off" />
      </div>
      <button class="btn" id="searchBtn">Search</button>
      <div class="prop-list" id="propertyList"></div>
    </div>

    <div class="separator"></div>
    <div class="section">
      <strong>Show layer on map</strong>
      <div class="radio-list" style="margin-top:8px;">
        <label><input type="radio" name="metric" value="none" checked> None</label>
        <label><input type="radio" name="metric" value="heat"> Urban Heat Islands</label>
        <label><input type="radio" name="metric" value="flood"> Flood Risk</label>
        <label><input type="radio" name="metric" value="air"> Air Quality</label>
        <label><input type="radio" name="metric" value="green"> Greenspace Access</label>
        <label><input type="radio" name="metric" value="infra"> Access to Critical Infrastructure</label>
        <label><input type="radio" name="metric" value="crime"> Crime Rate</label>
      </div>
      <div class="legend" id="legend" style="display:none;">
        <div style="font-weight:600; margin-bottom:6px;">Legend (randomized demo values)</div>
        <div class="row"><div class="swatch" style="background:#2b83ba"></div><div>Low</div></div>
        <div class="row"><div class="swatch" style="background:#7fbf7b"></div><div>Medium</div></div>
        <div class="row"><div class="swatch" style="background:#fee08b"></div><div>High</div></div>
      </div>
    </div>
  </aside>
</div>

<script>
// Initialize Leaflet map
const center = [52.221537, 6.893661];
const map = L.map('map').setView(center, 5);

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);
const gibsLST = L.tileLayer(
        'https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_Land_Surface_Temp_Day/default/2023-08-15/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png',
        {
          attribution: 'NASA GIBS',
          tileSize: 256,
          minZoom: 2,
          maxZoom: 18,  // Allow zooming to city level
          maxNativeZoom: 7,  // But tiles only exist up to zoom 7 - Leaflet will upscale
          opacity: 0.7,
          errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='
        }
);

const gibsAirPollution = L.tileLayer(
        'https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/OMPS_Aerosol_Index/default/2024-09-01/GoogleMapsCompatible_Level6/{z}/{y}/{x}.png',
        {
          attribution: 'NASA GIBS - Aerosol Index',
          tileSize: 256,
          minZoom: 2,
          maxZoom: 18,
          maxNativeZoom: 6,
          opacity: 0.7,
          errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='
        }
);

const baseLayers = { "OpenStreetMap": osm };
const overlayLayers = {
  "Land Surface Temp": gibsLST,
  "Air Pollution (Aerosol)": gibsAirPollution,
};
L.control.layers(baseLayers, overlayLayers).addTo(map);

const allGibsLayers = [gibsLST, gibsAirPollution];

function showLayer(layerName) {
  allGibsLayers.forEach(layer => {
    if (map.hasLayer(layer)) {
      map.removeLayer(layer);
    }
  });

  if (layerName === 'temp') {
    map.addLayer(gibsLST);
  } else if (layerName === 'pollution') {
    map.addLayer(gibsAirPollution);
  }
}

function hideLayer(layerName) {
  if (layerName === 'temp' && map.hasLayer(gibsLST)) {
    map.removeLayer(gibsLST);
  } else if (layerName === 'pollution' && map.hasLayer(gibsAirPollution)) {
    map.removeLayer(gibsAirPollution);
  }
}

function hideAllLayers() {
  allGibsLayers.forEach(layer => {
    if (map.hasLayer(layer)) {
      map.removeLayer(layer);
    }
  });
}

// Make functions globally accessible
window.showLayer = showLayer;
window.hideLayer = hideLayer;
window.hideAllLayers = hideAllLayers;

// Chart rendering
let chartInstances = [];
function renderCharts(){
  chartInstances.forEach(ch => ch.destroy());
  chartInstances = [];
  const labels = ["2019","2020","2021","2022","2023","2024","2025"];
  const randomData = () => labels.map(()=> Math.floor(Math.random()*100));
  chartInstances.push(new Chart(document.getElementById('chart1'), { type:'line', data:{ labels, datasets:[{label:"Urban Heat", data:randomData(), borderColor:"orange"}]} }));
  chartInstances.push(new Chart(document.getElementById('chart2'), { type:'line', data:{ labels, datasets:[{label:"Flood Risk", data:randomData(), borderColor:"blue"}]} }));
  chartInstances.push(new Chart(document.getElementById('chart3'), { type:'line', data:{ labels, datasets:[{label:"Crime Rate", data:randomData(), borderColor:"red"}]} }));
}

// Report toggle
let reportVisible = false;
function showReport(name){
  document.getElementById("map").style.display="none";
  document.getElementById("report").style.display="block";
  document.getElementById("reportTitle").innerText = name + " ‚Äî Report";
  renderCharts();
  reportVisible = true;
}
function showMap(){
  document.getElementById("map").style.display="block";
  document.getElementById("report").style.display="none";
  reportVisible = false;
}

// Property handling
let currentProperty=null;
function clearProperties(){
  document.getElementById("propertyList").innerHTML="";
  if(currentProperty){ map.removeLayer(currentProperty.marker); currentProperty=null; }
}
function addProperty(name,lat,lng){
  clearProperties();
  const marker = L.marker([lat,lng]).addTo(map).bindPopup(`<b>${name}</b>`);
  currentProperty={marker,lat,lng,name};
  const item=document.createElement("div");
  item.className="prop-item";
  item.innerHTML=`<div><div style="font-weight:600">${name}</div></div><div><span class="icon-btn">${reportVisible?'üó∫Ô∏è':'üìä'}</span></div>`;
  document.getElementById("propertyList").appendChild(item);

  // Open marker or toggle report
  item.addEventListener("click",()=>{ map.setView([lat,lng],17); marker.openPopup(); });
  const icon=item.querySelector(".icon-btn");
  icon.addEventListener("click",(e)=>{
    e.stopPropagation();
    if(reportVisible){ showMap(); icon.textContent="üìä"; }
    else{ showReport(name); icon.textContent="üó∫Ô∏è"; }
  });
}

// Search property
document.getElementById("searchBtn").addEventListener("click", async ()=>{
  const q=document.getElementById("searchInput").value.trim();
  if(!q)return alert("Please enter an address.");
  const url=`https://nominatim.openstreetmap.org/search?format=json&accept-language=en&limit=1&q=${encodeURIComponent(q)}`;
  const res=await fetch(url); const data=await res.json();
  if(!data.length)return alert("No results found.");
  const loc=data[0];
  addProperty(loc.display_name,parseFloat(loc.lat),parseFloat(loc.lon));
  map.setView([parseFloat(loc.lat),parseFloat(loc.lon)],16);
});

// Metric layers
let currentLayerGroup=null;
function clearMetricLayer(){
  if(currentLayerGroup){ map.removeLayer(currentLayerGroup); currentLayerGroup=null; }
  document.getElementById('legend').style.display='none';
}
function showMetric(metric){
  clearMetricLayer();
  if(metric==="none")return;
  const markers=L.markerClusterGroup();
  const center=map.getCenter();
  const points=generateRandomPoints(center.lat,center.lng,100,6);
  points.forEach((pt,idx)=>{
    const seed=idx*(metric.length*7);
    const val=pseudoRandom(seed)%100;
    const color=val>66?'#2b83ba':val>33?'#7fbf7b':'#fee08b';
    const html=`<div style="background:${color};color:#000;font-weight:bold;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border:1px solid #333;">${Math.floor(val)}</div>`;
    const icon=L.divIcon({html,className:'',iconSize:[30,30]});
    const marker=L.marker(pt,{icon}).bindPopup(`<b>${metric.toUpperCase()}</b><br>Value: ${val}`);
    markers.addLayer(marker);
  });
  map.addLayer(markers);
  currentLayerGroup=markers;
  document.getElementById('legend').style.display='block';
}
function generateRandomPoints(lat,lng,n=60,radiusKm=6){
  const pts=[];
  for(let i=0;i<n;i++){
    const r=Math.sqrt(Math.random())*radiusKm;
    const a=Math.random()*Math.PI*2;
    const dx=(r*Math.cos(a))/111;
    const dy=(r*Math.sin(a))/(111*Math.cos(lat*Math.PI/180));
    pts.push([lat+dx,lng+dy]);
  }
  return pts;
}
function pseudoRandom(seed){
  let x=Math.sin(seed+1)*10000;
  return Math.abs(x-Math.floor(x))*1000000%100;
}
document.querySelectorAll('input[name="metric"]').forEach(r => {
  r.addEventListener('change', e => {
    const val = e.target.value;
    clearMetricLayer();
    hideAllLayers(); // Now this function exists!

    if (val === 'heat') {
      showLayer('temp');
    } else if (val === 'flood') {
      showMetric('flood');
    } else if (val === 'air') {
      showLayer('pollution');
    } else if (val === 'none') {
      // All layers already hidden
    } else {
      showMetric(val);
    }
  });
});
</script>
</body>
</html>
